<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CID OCR (Center Crop + Multi-Resolution Skip Rotation)</title>
<script src="public/js/opencv.js"></script>
<script src="public/js/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; }
  canvas { margin: 5px; border: 1px solid #ccc; max-width: 45%; height: auto; }
  #canvases { display: flex; flex-wrap: wrap; justify-content: start; align-items: start; }
  .label { text-align: center; font-size: 14px; margin: 4px 0; }
  #btns { margin:10px 0; }
  button, select { margin-right:8px; padding:6px 12px; border-radius:5px; }
  button { background:#007bff; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#0056b3; }
  select { border:1px solid #ccc; }
</style>
</head>
<body>
<h3>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (Center Crop + Multi-Resolution Skip Rotation)</h3>

<input type="file" id="fileInput" accept="image/*"><br>

<div id="btns">
  <label for="cropSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á): </label>
  <select id="cropSelect">
    <option value="100">100% (‡πÄ‡∏ï‡πá‡∏°‡∏†‡∏≤‡∏û)</option>
    <option value="90" selected>90%</option>
    <option value="85">85%</option>
    <option value="80">80%</option>
  </select>
  <button id="rotateLeft">‚Ü©Ô∏è ‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</button>
  <button id="rotateRight">‚Ü™Ô∏è ‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤</button>
  <button id="startOCR">üîç ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR</button>
</div>

<pre id="output"></pre>
<div id="canvases">
  <div>
    <canvas id="cvCanvas1"></canvas>
    <div class="label">‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</div>
  </div>
  <div>
    <canvas id="cvCanvas2"></canvas>
    <div class="label">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ OCR</div>
  </div>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const output = document.getElementById("output");
const c1 = document.getElementById("cvCanvas1");
const c2 = document.getElementById("cvCanvas2");
const startBtn = document.getElementById("startOCR");
const cropSelect = document.getElementById("cropSelect");

let srcMat = null;
let cropPercent = 0.85; // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 85%

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à checksum
function validateThaiID(id){
  if(!/^\d{13}$/.test(id)) return false;
  const d = id.split('').map(Number);
  let s=0; for(let i=0;i<12;i++) s+=d[i]*(13-i);
  return (11-(s%11))%10===d[12];
}
function autoFixThaiIDByChecksum(id){
  if(!/^\d{13}$/.test(id)) return null;
  if(validateThaiID(id)) return id;
  const arr=id.split('').map(n=>+n);
  for(let i=0;i<13;i++){
    const orig=arr[i];
    for(let d=0;d<=9;d++){
      if(d===orig) continue;
      arr[i]=d;
      const cand=arr.join('');
      if(validateThaiID(cand)) return cand;
    }
    arr[i]=orig;
  }
  return null;
}

// üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏™‡∏á‡∏†‡∏≤‡∏û
function autoContrastLevel(grayMat){
  const meanScalar = cv.mean(grayMat);
  const brightness = meanScalar[0];
  let claheClip = 1.5, sharpWeight = 1.2, blurWeight = -0.2, normMin = 30, normMax = 230;
  if (brightness < 80) { claheClip = 3.0; sharpWeight = 1.4; blurWeight = -0.4; normMin = 20; normMax = 250; }
  else if (brightness > 150) { claheClip = 1.0; sharpWeight = 1.1; blurWeight = -0.1; normMin = 40; normMax = 210; }
  return { claheClip, sharpWeight, blurWeight, normMin, normMax, brightness };
}

// üü• ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô crop
function drawCropGuides(){
  if(!srcMat) return;
  const ctx = c1.getContext("2d");
  ctx.clearRect(0,0,c1.width,c1.height);
  cv.imshow(c1,srcMat);

  const remain = cropPercent;
  const cut = (1 - remain) / 2;
  const y1 = Math.floor(c1.height * cut);
  const y2 = Math.floor(c1.height * (1 - cut));

  ctx.beginPath();
  ctx.strokeStyle = "red";
  ctx.lineWidth = 3;
  ctx.moveTo(0,y1);
  ctx.lineTo(c1.width,y1);
  ctx.moveTo(0,y2);
  ctx.lineTo(c1.width,y2);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,0,0,0.8)";
  ctx.font = "16px sans-serif";
  ctx.fillText(`‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏≤‡∏á ${Math.round(remain*100)}%`,10,Math.max(20,y1-10));
  output.textContent = `üìè Crop ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ${(cut*100).toFixed(1)}% ‡πÅ‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ${(cut*100).toFixed(1)}% ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏≤‡∏á ${(remain*100).toFixed(0)}%`;
}

// üß© OCR
async function runOCR(mat,label="full"){
  const temp = document.createElement("canvas");
  temp.width=mat.cols; temp.height=mat.rows;
  cv.imshow(temp,mat);
  await new Promise(r=>setTimeout(r,10));
  const { data } = await Tesseract.recognize(temp,'eng',{tessedit_char_whitelist:'0123456789'});
  const txt=data.text.replace(/\s+/g,'');
  const m=txt.match(/\d{13}/);
  if(!m) return {cid:null,raw:txt,zone:label};
  let cid=m[0];
  if(!validateThaiID(cid)){const fix=autoFixThaiIDByChecksum(cid);if(fix) cid=fix;}
  return {cid:validateThaiID(cid)?cid:null,raw:txt,zone:label};
}

async function processImage(mat,maxW,angle){
  let gray=new cv.Mat();
  cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);
  const { claheClip, sharpWeight, blurWeight, normMin, normMax }=autoContrastLevel(gray);
  const clahe=new cv.CLAHE(claheClip,new cv.Size(8,8));
  const cl=new cv.Mat(); clahe.apply(gray,cl);
  const blur=new cv.Mat(); cv.GaussianBlur(cl,blur,new cv.Size(0,0),1.0);
  const sharp=new cv.Mat(); cv.addWeighted(cl,sharpWeight,blur,blurWeight,0,sharp);
  const denoise=new cv.Mat(); cv.bilateralFilter(sharp,denoise,5,30,30);
  cv.normalize(denoise,denoise,normMin,normMax,cv.NORM_MINMAX);
  const bin=new cv.Mat(); cv.adaptiveThreshold(denoise,bin,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,35,10);
  const up=new cv.Mat(); cv.resize(bin,up,new cv.Size(0,0),1.5,1.5,cv.INTER_CUBIC);
  cv.imshow(c2,up);
  const res=await runOCR(up,"center-zone");
  gray.delete();clahe.delete();cl.delete();blur.delete();sharp.delete();denoise.delete();bin.delete();up.delete();
  return {...res,maxW,angle};
}

// üì¶ ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
fileInput.addEventListener("change", e=>{
  const f=e.target.files[0]; if(!f)return;
  const img=new Image();
  img.src=URL.createObjectURL(f);
  img.onload=()=>{
    const fileSizeMB=f.size/1024/1024;
    let maxW=img.width; if(fileSizeMB>2)maxW=1280;
    const scale=img.width>maxW?maxW/img.width:1;
    c1.width=img.width*scale; c1.height=img.height*scale;
    const ctx=c1.getContext("2d");
    ctx.drawImage(img,0,0,c1.width,c1.height);
    if(srcMat)srcMat.delete();
    srcMat=cv.imread(c1);
    drawCropGuides();
  };
});

// üîÑ ‡∏´‡∏°‡∏∏‡∏ô‡∏†‡∏≤‡∏û
document.getElementById("rotateLeft").onclick=()=>rotate(-90);
document.getElementById("rotateRight").onclick=()=>rotate(90);
function rotate(deg){
  if(!srcMat)return;
  const rot=new cv.Mat();
  if(deg===90)cv.rotate(srcMat,rot,cv.ROTATE_90_CLOCKWISE);
  else cv.rotate(srcMat,rot,cv.ROTATE_90_COUNTERCLOCKWISE);
  srcMat.delete();
  srcMat=rot;
  cv.imshow(c1,srcMat);
  drawCropGuides();
}

// üîÅ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
cropSelect.addEventListener("change", ()=>{
  cropPercent = parseInt(cropSelect.value)/100;
  drawCropGuides();
});

// üß† ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR
startBtn.onclick = async ()=>{
  if(!srcMat){output.textContent="‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û";return;}
  output.textContent="‚è≥ ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR ...\n";

  const remain = cropPercent;
  const cut = (1 - remain) / 2;
  const y1 = Math.floor(srcMat.rows * cut);
  const y2 = Math.floor(srcMat.rows * (1 - cut));
  const cropHeight = y2 - y1;

  const cropRect = new cv.Rect(0, y1, srcMat.cols, cropHeight);
  const cropped = srcMat.roi(cropRect).clone();

  const resolutions=[800,960,1280];
  const aspect=cropped.cols/cropped.rows;
  const angles=(aspect>1.2)?[0]:[0,270,180,90];
  let results=[];
  for(const maxW of resolutions){
    output.textContent+=`\n=== üîç ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏î maxW=${maxW} ===\n`;
    const scale=cropped.cols>maxW?maxW/cropped.cols:1;
    const resized=new cv.Mat(); cv.resize(cropped,resized,new cv.Size(0,0),scale,scale,cv.INTER_AREA);
    let found=false;
    for(const a of angles){
      if(found)break;
      let rot=new cv.Mat();
      if(a===0)rot=resized.clone();
      else if(a===90)cv.rotate(resized,rot,cv.ROTATE_90_CLOCKWISE);
      else if(a===180)cv.rotate(resized,rot,cv.ROTATE_180);
      else if(a===270)cv.rotate(resized,rot,cv.ROTATE_90_COUNTERCLOCKWISE);
      const res=await processImage(rot,maxW,a);
      results.push(res);
      if(res.cid){found=true;output.textContent+=`‚úÖ ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç ${res.cid} ‡∏ó‡∏µ‡πà maxW=${maxW}, angle=${a}¬∞\n`;break;}
      rot.delete();
    }
    resized.delete();
  }
  cropped.delete();
  const found=results.find(r=>r.cid);
  if(found)output.textContent+=`\n‚úÖ ‡∏™‡∏£‡∏∏‡∏õ: ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç ${found.cid} ‡∏à‡∏≤‡∏Å zone ${found.zone}, ‡∏°‡∏∏‡∏° ${found.angle}¬∞\n`;
  else output.textContent+=`\n‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î`;
};
</script>
</body>
</html>
