<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CID OCR (Camera Capture + Center Crop + Manual OCR)</title>
<script src="public/js/opencv.js"></script>
<script src="public/js/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; }
  canvas { margin: 5px; border: 1px solid #ccc; max-width: 45%; height: auto; }
  #canvases { display: flex; flex-wrap: wrap; justify-content: start; align-items: start; }
  .label { text-align: center; font-size: 14px; margin: 4px 0; }
  #btns { margin:10px 0; }
  button, select { margin-right:8px; padding:6px 12px; border-radius:5px; }
  button { background:#007bff; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#0056b3; }
  select { border:1px solid #ccc; }
  .cv-hide {display:none}

  /* ‚úÖ Progress bar with smooth red‚Üíyellow‚Üígreen transition */
  #progress-container {
    width: 100%;
    max-width: 400px;
    background-color: #eee;
    border-radius: 10px;
    margin-top: 15px;
    height: 26px;
    overflow: hidden;
    display: none;
    position: relative;
  }
  #progress-bar {
    height: 100%;
    width: 0%;
    background-color: red;
    transition: width 0.4s ease, background-color 0.4s linear;
    border-radius: 10px;
  }

  /* üîπ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ú‡∏• OCR */
#ocr-select {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
  gap: 8px;
  margin-top: 10px;
  max-width: 400px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏£‡∏ß‡∏° */
}

/* üîπ ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô (‡∏à‡∏≤‡∏Å <p>) */
.clickable {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 6px;
  background-color: #f8f8f8;
  color: #333;
  cursor: pointer;
  transition: background 0.25s, transform 0.15s;
  font-size: 13px;
  font-weight: 500;
  user-select: none;
  line-height: 1.4;
  text-align: center;
  border: 1px solid #ddd;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.clickable:hover {
  background-color: #f0f0f0;
  transform: scale(1.03);
}

/* üîπ ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö recommend */
.blink .label {
  animation: blinkGlow 1.2s infinite ease-in-out;
  font-weight: 600;
  font-size: 13px;
}

/* üîπ ‡∏î‡∏≤‡∏ß‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö */
.star {
  color: gold;
  text-shadow: 0 0 8px #ffcc33, 0 0 15px #ffaa00;
  animation: starTwinkle 1.5s infinite ease-in-out;
  margin-left: 3px;
  font-size: 13px;
}

@keyframes blinkGlow {
  0%, 100% {
    color: #ff4444;
    text-shadow: 0 0 5px #ff8888, 0 0 10px #ffcc66;
  }
  50% {
    color: #ffaa00;
    text-shadow: 0 0 8px #ffee66, 0 0 16px #ffee99;
  }
}

@keyframes starTwinkle {
  0%, 100% { opacity: 0.7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}


</style>
</head>
<body>
<h3>üì∏ ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û + Center Crop + Manual OCR)</h3>

<input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">

<div id="btns">
  <button id="takePhoto">üì∑</button>
  <label for="cropSelect">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö</label>
  <select id="cropSelect">
    <option value="100">‡∏†‡∏≤‡∏û‡πÄ‡∏ï‡πá‡∏°</option>
    <option value="90" selected>90%</option>
    <option value="85">85%</option>
    <option value="80">80%</option>
  </select>
  <button id="rotateLeft">‚Ü©Ô∏è</button>
  <button id="startOCR">üîç OCR</button>
</div>

<!-- ‚úÖ Progress bar -->
<div id="progress-container">
  <div id="progress-bar"></div>
</div>

<pre id="output"></pre>
<div id="ocr-select">

</div>

<div id="canvases">
  <div>
    <canvas id="cvCanvas1"></canvas>
    <div class="label cv-hide">‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
  </div>
  <div class="cv-hide">
    <canvas id="cvCanvas2"></canvas>
    <div class="label">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ OCR</div>
  </div>
</div>

<script>
const fileInput = document.getElementById("fileInput");
const takePhotoBtn = document.getElementById("takePhoto");
const output = document.getElementById("output");
const c1 = document.getElementById("cvCanvas1");
const c2 = document.getElementById("cvCanvas2");
const startBtn = document.getElementById("startOCR");
const cropSelect = document.getElementById("cropSelect");
const rotateLeftBtn = document.getElementById("rotateLeft");
const progressContainer = document.getElementById("progress-container");
const progressBar = document.getElementById("progress-bar");

let srcMat = null;
let cropPercent = 0.9; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 90%

function validateThaiID(id){
  if(!/^\d{13}$/.test(id)) return false;
  const d=id.split('').map(Number);
  let s=0; for(let i=0;i<12;i++) s+=d[i]*(13-i);
  return (11-(s%11))%10===d[12];
}
function autoFixThaiIDByChecksum(id){
  if(!/^\d{13}$/.test(id)) return null;
  if(validateThaiID(id)) return id;
  const arr=id.split('').map(n=>+n);
  for(let i=0;i<13;i++){
    const orig=arr[i];
    for(let d=0;d<=9;d++){
      if(d===orig) continue;
      arr[i]=d;
      const cand=arr.join('');
      if(validateThaiID(cand)) return cand;
    }
    arr[i]=orig;
  }
  return null;
}

function autoContrastLevel(grayMat){
  const meanScalar=cv.mean(grayMat);
  const brightness=meanScalar[0];
  let claheClip=1.5,sharpWeight=1.2,blurWeight=-0.2,normMin=30,normMax=230;
  if(brightness<80){claheClip=3.0;sharpWeight=1.4;blurWeight=-0.4;normMin=20;normMax=250;}
  else if(brightness>150){claheClip=1.0;sharpWeight=1.1;blurWeight=-0.1;normMin=40;normMax=210;}
  return{claheClip,sharpWeight,blurWeight,normMin,normMax,brightness};
}

function drawCropGuides(){
  if(!srcMat) return;
  const ctx=c1.getContext("2d");
  ctx.clearRect(0,0,c1.width,c1.height);
  cv.imshow(c1,srcMat);
  const remain=cropPercent;
  const cut=(1-remain)/2;
  const y1=Math.floor(c1.height*cut);
  const y2=Math.floor(c1.height*(1-cut));
  ctx.beginPath();
  ctx.strokeStyle="red";
  ctx.lineWidth=3;
  ctx.moveTo(0,y1);
  ctx.lineTo(c1.width,y1);
  ctx.moveTo(0,y2);
  ctx.lineTo(c1.width,y2);
  ctx.stroke();
  ctx.fillStyle="rgba(255,0,0,0.8)";
  ctx.font="16px sans-serif";
  ctx.fillText(`‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà OCR ‡∏Å‡∏•‡∏≤‡∏á ${Math.round(remain*100)}%`,10,Math.max(20,y1-10));
  console.log(`üì∑ ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏≤‡∏á ${(remain*100).toFixed(0)}%`);
}

async function runOCR(mat,label="full"){
  const temp=document.createElement("canvas");
  temp.width=mat.cols;temp.height=mat.rows;
  cv.imshow(temp,mat);
  await new Promise(r=>setTimeout(r,10));
  const {data}=await Tesseract.recognize(temp,'eng',{tessedit_char_whitelist:'0123456789'});
  const txt=data.text.replace(/\s+/g,'');
  const m=txt.match(/\d{13}/);
  if(!m)return{cid:null,raw:txt,zone:label};
  let cid=m[0];
  if(!validateThaiID(cid)){const fix=autoFixThaiIDByChecksum(cid);if(fix)cid=fix;}
  return{cid:validateThaiID(cid)?cid:null,raw:txt,zone:label};
}

async function processImage(mat,maxW,angle){
  let gray=new cv.Mat();
  cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);
  const {claheClip,sharpWeight,blurWeight,normMin,normMax}=autoContrastLevel(gray);
  const clahe=new cv.CLAHE(claheClip,new cv.Size(8,8));
  const cl=new cv.Mat();clahe.apply(gray,cl);
  const blur=new cv.Mat();cv.GaussianBlur(cl,blur,new cv.Size(0,0),1.0);
  const sharp=new cv.Mat();cv.addWeighted(cl,sharpWeight,blur,blurWeight,0,sharp);
  const denoise=new cv.Mat();cv.bilateralFilter(sharp,denoise,5,30,30);
  cv.normalize(denoise,denoise,normMin,normMax,cv.NORM_MINMAX);
  const bin=new cv.Mat();cv.adaptiveThreshold(denoise,bin,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,35,10);
  const up=new cv.Mat();cv.resize(bin,up,new cv.Size(0,0),1.5,1.5,cv.INTER_CUBIC);
  cv.imshow(c2,up);
  const res=await runOCR(up,"center-zone");
  gray.delete();clahe.delete();cl.delete();blur.delete();sharp.delete();denoise.delete();bin.delete();up.delete();
  return{...res,maxW,angle};
}

takePhotoBtn.addEventListener("click", ()=>{
  const ctx1=c1.getContext("2d");
  const ctx2=c2.getContext("2d");
  ctx1.clearRect(0,0,c1.width,c1.height);
  ctx2.clearRect(0,0,c2.width,c2.height);
  if(srcMat){srcMat.delete();srcMat=null;}
  fileInput.value="";
  fileInput.click();
});

fileInput.addEventListener("change", e=>{
  const f=e.target.files[0];if(!f)return;
  const img=new Image();
  img.src=URL.createObjectURL(f);
  img.onload=()=>{
    const fileSizeMB=f.size/1024/1024;
    let maxW=img.width;if(fileSizeMB>2)maxW=1280;
    const scale=img.width>maxW?maxW/img.width:1;
    c1.width=img.width*scale;c1.height=img.height*scale;
    const ctx=c1.getContext("2d");
    ctx.drawImage(img,0,0,c1.width,c1.height);
    if(srcMat)srcMat.delete();
    srcMat=cv.imread(c1);
    drawCropGuides();
  };
});

rotateLeftBtn.onclick=()=>{
  if(!srcMat)return;
  const rot=new cv.Mat();
  cv.rotate(srcMat,rot,cv.ROTATE_90_COUNTERCLOCKWISE);
  srcMat.delete();
  srcMat=rot;
  cv.imshow(c1,srcMat);
  drawCropGuides();
};

cropSelect.addEventListener("change", ()=>{
  cropPercent=parseInt(cropSelect.value)/100;
  drawCropGuides();
});

startBtn.onclick=async()=>{
  if(!srcMat){output.textContent="‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û";return;}
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  progressBar.style.backgroundColor = "red";
  output.textContent="";
  
  const remain=cropPercent;
  const cut=(1-remain)/2;
  const y1=Math.floor(srcMat.rows*cut);
  const y2=Math.floor(srcMat.rows*(1-cut));
  const cropHeight=y2-y1;
  const cropRect=new cv.Rect(0,y1,srcMat.cols,cropHeight);
  const cropped=srcMat.roi(cropRect).clone();
  output.textContent=`‚è≥ start OCR...`;
  console.log(`üü¶ ‡πÄ‡∏£‡∏¥‡πà‡∏° OCR ‡∏ó‡∏µ‡πà crop ${(remain*100).toFixed(0)}% (${y1}-${y2})`);
  
  const resolutions=[800,960,1280];
  const aspect=cropped.cols/cropped.rows;
  const angles=(aspect>1.2)?[0]:[0,270,180,90];
  
  let results=[];
  let total=resolutions.length*angles.length;
  let done=0;

  for(const maxW of resolutions){
    console.log(`\n=== üîç ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏î maxW=${maxW} ===`);
    const scale=cropped.cols>maxW?maxW/cropped.cols:1;
    const resized=new cv.Mat();cv.resize(cropped,resized,new cv.Size(0,0),scale,scale,cv.INTER_AREA);
    let found=false;
    for(const a of angles){
      if(found)break;
      console.log(`  ‚ñ∂Ô∏è ‡∏´‡∏°‡∏∏‡∏ô‡∏†‡∏≤‡∏û ${a}¬∞`);
      let rot=new cv.Mat();
      if(a===0)rot=resized.clone();
      else if(a===90)cv.rotate(resized,rot,cv.ROTATE_90_CLOCKWISE);
      else if(a===180)cv.rotate(resized,rot,cv.ROTATE_180);
      else if(a===270)cv.rotate(resized,rot,cv.ROTATE_90_COUNTERCLOCKWISE);
      const res=await processImage(rot,maxW,a);
      results.push(res);
      done++;
      const percent=Math.round((done/total)*100);
      progressBar.style.width = percent+"%";

      // üé® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
      if(percent < 50){
        // ‡∏à‡∏≤‡∏Å‡πÅ‡∏î‡∏á (#ff0000) ‚Üí ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (#ffff00)
        const g = Math.floor((percent / 50) * 255);
        progressBar.style.backgroundColor = `rgb(255,${g},0)`;
      } else {
        // ‡∏à‡∏≤‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (#ffff00) ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (#00ff00)
        const r = Math.floor(255 - ((percent - 50) / 50) * 255);
        progressBar.style.backgroundColor = `rgb(${r},255,0)`;
      }

      console.log(`  ‚è≥ Progress ${percent}%`);
      if(res.cid){
        found=true;
        console.log(`‚úÖ ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç ${res.cid} ‡∏ó‡∏µ‡πà maxW=${maxW}, angle=${a}¬∞`);
        break;
      }
      rot.delete();
    }
    resized.delete();
  }
  cropped.delete();
  progressBar.style.width = "100%";
  progressBar.style.backgroundColor = "rgb(0,255,0)";
  setTimeout(()=>progressContainer.style.display="none",1200);
  
  const ffil = results.filter(r=>r.cid).map(r=>r.cid);  
  console.log("filter: ",ffil)
  
  const found=results.find(r=>r.cid);
  if(ffil.length > 0){
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô array
    const countMap = {};
    ffil.forEach(cid => {
      countMap[cid] = (countMap[cid] || 0) + 1;
    });

    const uniqcid = [...new Set(ffil)];
    console.log("unique: ", uniqcid);

    let result_html = "";
    uniqcid.forEach((cid, i) => {
      const isRecommend = countMap[cid] > 1;
      const label = isRecommend ? `‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ <span class="star">‚≠ê</span>` : "‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤";
      const blinkClass = isRecommend ? "blink" : "";

      result_html += `
        <p class="clickable ${blinkClass}" onclick="chooseCid(${i})">
          <input type="hidden" id="ocrcid${i}" value="${cid}">
          ${cid} <span class="label">${label}</span>
        </p>
      `;
    });
    document.getElementById("ocr-select").innerHTML = result_html;
    output.textContent = "";
    //output.textContent=`‚úÖ ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç ${found.cid} ‡∏à‡∏≤‡∏Å zone ${found.zone}, ‡∏°‡∏∏‡∏° ${found.angle}¬∞`;
    //console.log(`üéØ OCR Result: ${found.cid}`);
  }else{
    output.textContent=`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î`;
    console.warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î");
  }
};

function chooseCid(i){
  const cid = document.getElementById('ocrcid'+i).value
  console.log("chooseCid: ",cid)
}
</script>
</body>
</html>
